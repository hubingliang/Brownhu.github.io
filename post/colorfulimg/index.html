<html>
  <head>
    <meta charset="utf-8" />
<meta name="description" content="" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>使用ColorfulImg获取图片主题色！ | BrownHu</title>
<link rel="shortcut icon" href="https://hubingliang.github.io/favicon.ico?v=1562144808907">
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css">
<link rel="stylesheet" href="https://hubingliang.github.io/styles/main.css">

<script src="https://cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>
<script src="https://cdn.bootcss.com/moment.js/2.23.0/moment.min.js"></script>



  </head>
  <body>
    <div class="main">
      <div class="main-content">
        <div class="site-header">
  <a href="https://hubingliang.github.io">
  <img class="avatar" src="https://hubingliang.github.io/images/avatar.png?v=1562144808907" alt="">
  </a>
  <h1 class="site-title">
    BrownHu
  </h1>
  <p class="site-description">
    Better late then never
  </p>
  <div class="menu-container">
    
      
        <a href="/" class="menu">
          首页
        </a>
      
    
      
        <a href="/archives" class="menu">
          归档
        </a>
      
    
      
        <a href="/tags" class="menu">
          标签
        </a>
      
    
      
        <a href="/post/about" class="menu">
          关于
        </a>
      
    
  </div>
  <div class="social-container">
    
      
        <a href="https://github.com/hubingliang" target="_blank">
          <i class="fab fa-github"></i>
        </a>
      
    
      
    
      
    
      
        <a href="https://www.zhihu.com/people/hu-bing-liang-97/activities" target="_blank">
          <i class="fab fa-zhihu"></i>
        </a>
      
    
      
    
  </div>
</div>


        <div class="post-detail">
          <article class="post">
            <h2 class="post-title">
              使用ColorfulImg获取图片主题色！
            </h2>
            <div class="post-info">
              <time class="post-time">
                · 2018-03-29 ·
              </time>
              
                <a href="https://hubingliang.github.io/tag/Front-end" class="post-tag">
                  # Front-end
                </a>
              
            </div>
            
              <div class="post-feature-image" style="background-image: url('https://hubingliang.github.io/post-images/colorfulimg.jpeg')">
              </div>
            
            <div class="post-content">
              <h2 id="取色网站">取色网站</h2>
<p><img src="https://user-gold-cdn.xitu.io/2018/9/12/165c960c72a38dae?w=1240&amp;h=739&amp;f=png&amp;s=555321" alt="">
前几天遇到了获取图片主题色的需求，于是去找了一些相关的博客，发现实现起来相当简单，于是自己开发了一个获取图片主题色的网站---<a href="https://hubingliang.github.io/colorfulImg/dist/">ColorfulImg</a>
大家可以通过上传/拖拽图片的方式获取图片主题色。</p>
<p>欢迎Star~</p>
<h2 id="colorfulimg">ColorfulImg</h2>
<p>Colorfulimg是一个能够通过canvas获取图片主题色的js工具库。</p>
<p>安装：</p>
<p><code>npm i colorfulimg</code></p>
<p>使用方法：</p>
<pre><code class="language-js">let colorfulimg = require('colorfulimg') 
let myImg = document.getElementById('myImg')
let rgb = colorfulImg(myImg);
</code></pre>
<p><a href="https://github.com/hubingliang/colorfulImg">这是项目地址</a></p>
<p>欢迎star~</p>
<h2 id="colorfulimg实现思路">ColorfulImg实现思路</h2>
<p>下面说一下实现思路，主要是通过<a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Canvas_API/Tutorial">canvas</a>的<a href="https://developer.mozilla.org/zh-CN/docs/Web/API/ImageData">getImageData()</a>方法获取图片每个像素点的rgba数据。通过取得平均值的方法来算出图片主题色。
所以要想实现此效果有两个限制：</p>
<ul>
<li>网站和图片必须是相同的域名（getImageData()限制图片必须同源）</li>
<li>浏览器必须支持canvas</li>
</ul>
<h3 id="在canvas中绘制img图像">在canvas中绘制img图像</h3>
<ol>
<li>首先我们要新建一个canvas标签并且访问它的绘画上下文：</li>
</ol>
<pre><code class="language-js">let canvas = document.createElement('canvas')
let context = canvas.getContext &amp;&amp; canvas.getContext('2d')
</code></pre>
<ol start="2">
<li>绘制img图像，X轴与Y轴的起始点都设置为0：</li>
</ol>
<pre><code class="language-js">let myImg = document.getElementById('myImg')
context.drawImage(myImg , 0, 0)
</code></pre>
<h3 id="获取图片颜色数据getimagedata">获取图片颜色数据getImageData()</h3>
<p><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/ImageData">getImageData()</a>这个API需要四个参数，前两个是获取图片数据的起点，后两个是提取的图像数据矩形区域的宽度和高度，我们要得到图片全部的数据所以后两个参数就是图片的宽高，于此同时我们也要把canvas的宽高设置为图片的宽高能完全装下图片。</p>
<pre><code class="language-js">let height = canvas.height = imgEl.height
let width = canvas.width = imgEl.width
let data = context.getImageData(0, 0, width, height).data
</code></pre>
<p>在我第一次测试的时候遇到了跨域的问题：</p>
<p><img src="https://user-gold-cdn.xitu.io/2018/9/12/165c960c72b06536?w=631&amp;h=171&amp;f=png&amp;s=9973" alt=""></p>
<p>图片如果不同源的话必须要加<code>crossorigin=&quot;anonymous&quot;</code>的属性，并且服务器存储那边也要开放相应的权限才行。
<code>&lt;img id=&quot;img&quot; crossorigin=&quot;anonymous&quot;&gt;</code></p>
<h3 id="处理获取的颜色数据">处理获取的颜色数据</h3>
<p>我们先log一下拿到的数据是什么吧：</p>
<p><img src="https://user-gold-cdn.xitu.io/2018/9/12/165c960c72cc7c75?w=631&amp;h=295&amp;f=png&amp;s=9846" alt=""></p>
<p>是一个有着一堆数据的数组，这些数据是什么呢？我们先看一下MDN：</p>
<p><img src="https://user-gold-cdn.xitu.io/2018/9/12/165c960c72e4542f?w=773&amp;h=120&amp;f=png&amp;s=15815" alt=""></p>
<p>也就是说按顺序来看前四位组成一个以RGBA顺序的数据：
<strong>rgba(red, green, blue, alpha)</strong></p>
<p>对于获取的图片数据透明度（alpha）都是255也就是不透明的所以我们不对透明度做处理，之后我们只需要把rgb的其他三个值分别求和再取均值就可以得到图片的主题色了！</p>
<pre><code class="language-js">let count = 0
let i = 0
let blockSize = 1
while ( (i += blockSize * 4) &lt; length ) {
  ++count
  rgb.r = data[i] + rgb.r 
  rgb.g = data[i+1] + rgb.g
  rgb.b = data[i+2] + rgb.b
}
rgb.r = ~~(rgb.r/count)
rgb.g = ~~(rgb.g/count)
rgb.b = ~~(rgb.b/count)
</code></pre>
<h3 id="最终代码">最终代码</h3>
<pre><code class="language-js">function colorfulImg(img){
    let canvas = document.createElement('canvas'),
        context = canvas.getContext &amp;&amp; canvas.getContext('2d'),
        height,width,length,data, 
        i = -4,
        blockSize = 5,
        count = 0,
        rgb = {r:0,g:0,b:0}
            
    height = canvas.height = imgEl.height
    width = canvas.width = imgEl.width
    context.drawImage(imgEl, 0, 0);
    data = context.getImageData(0, 0, width, height).data
    length = data.length
    while ( (i += blockSize * 4) &lt; length ) {
    ++count;
    rgb.r += data[i];
    rgb.g += data[i+1];
    rgb.b += data[i+2];
    }
    rgb.r = ~~(rgb.r/count);
    rgb.g = ~~(rgb.g/count);
    rgb.b = ~~(rgb.b/count);
    return rgb;
}
</code></pre>

            </div>
          </article>
        </div>

        
          <div class="next-post">
            <div class="next">下一篇</div>
            <a href="https://hubingliang.github.io/post/=&gt;">
              <h3 class="post-title">
                吃透ES6----简洁优雅的箭头函数
              </h3>
            </a>
          </div>
        

        

        <div class="site-footer">
  C'est la vie | 
  <a class="rss" href="https://hubingliang.github.io/atom.xml" target="_blank">RSS</a>
</div>

<script>
  hljs.initHighlightingOnLoad()
</script>

      </div>
    </div>
  </body>
</html>
